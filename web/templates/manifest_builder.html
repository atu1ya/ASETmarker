{% extends 'base.html' %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<div class="container">
  <h2>Manifest Builder</h2>
  <form id="manifest-form" onsubmit="return false;">
    <div class="form-group">
      <label for="csv-upload">Import Student Data (CSV or Excel):</label>
      <input type="file" id="csv-upload" class="input" accept=".csv,.xlsx,.xls" onchange="importFile(event)">
      <p class="help-text">Upload a CSV or Excel file with "Student Name" and "Writing Score" columns to auto-populate the table.</p>
    </div>
    <div class="form-group">
      <label for="student-names">Student Names (one per line):</label>
      <textarea id="student-names" class="input" rows="6" placeholder="Enter one name per line"></textarea>
    </div>
    <div class="form-group">
      <label>Filename Pattern:</label>
      <div style="display: flex; gap: 8px; align-items: center;">
        <input id="prefix" class="input" type="text" placeholder="Prefix (e.g. 2026_)" style="width: 120px;">
        <span>+ Student Name +</span>
        <input id="suffix" class="input" type="text" placeholder="Suffix (optional)" style="width: 140px;">
      </div>
    </div>
    <div class="form-group">
      <label>Image File Extension:</label>
      <div id="ext-buttons" style="display: flex; gap: 8px; margin-top: 4px;">
        <button type="button" class="button ext-btn is-primary" data-ext="jpg" onclick="selectExtension('jpg')">JPG</button>
        <button type="button" class="button ext-btn" data-ext="jpeg" onclick="selectExtension('jpeg')">JPEG</button>
        <button type="button" class="button ext-btn" data-ext="png" onclick="selectExtension('png')">PNG</button>
      </div>
      <input type="hidden" id="selected-extension" value="jpg">
    </div>
    <div class="form-group">
      <button type="button" class="button" onclick="generateTable()">Generate Table</button>
    </div>
  </form>
  <div id="table-section" style="margin-top: 2em; display: none;">
    <h3>Students</h3>
    <div style="overflow-x:auto;">
      <table id="students-table" class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Writing Score</th>
            <th>Reading File</th>
            <th>QRAR File</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button class="button" onclick="downloadManifest()">Download manifest.json</button>
  </div>
</div>
<script>
function sanitizeFilename(str) {
  return str.trim().replace(/[^a-zA-Z0-9_-]/g, '_');
}

function selectExtension(ext) {
  document.getElementById('selected-extension').value = ext;
  // Update button styles
  document.querySelectorAll('#ext-buttons .ext-btn').forEach(btn => {
    btn.classList.remove('is-primary');
    if (btn.dataset.ext === ext) {
      btn.classList.add('is-primary');
    }
  });
  // Regenerate table if it exists to update filenames
  regenerateFilenames();
}

function getSelectedExtension() {
  return document.getElementById('selected-extension').value || 'png';
}

function regenerateFilenames() {
  const rows = document.querySelectorAll('#students-table tbody tr');
  if (rows.length === 0) return;
  
  const prefix = document.getElementById('prefix').value;
  const suffix = document.getElementById('suffix').value;
  const ext = getSelectedExtension();
  
  rows.forEach(row => {
    const cells = row.querySelectorAll('input');
    const name = cells[0].value.trim();
    const sanitized = sanitizeFilename(name);
    cells[2].value = `${prefix}${sanitized}_reading.${ext}${suffix}`.replace(/_+/g, '_');
    cells[3].value = `${prefix}${sanitized}_qrar.${ext}${suffix}`.replace(/_+/g, '_');
  });
}

function importFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const fileName = file.name.toLowerCase();
  if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
    importExcel(file);
  } else if (fileName.endsWith('.csv')) {
    importCSV(file);
  } else {
    alert('Please upload a CSV or Excel file (.csv, .xlsx, .xls)');
  }
}

// Fuzzy column matching patterns
const NAME_PATTERNS = [
  /^student\s*name$/i,
  /^name$/i,
  /^student$/i,
  /^candidate$/i,
  /^first\s*name$/i,
  /^full\s*name$/i,
  /student.*name/i,
  /name.*student/i,
  /candidate.*name/i
];

const WRITING_PATTERNS = [
  /^writing\s*score$/i,
  /^writing$/i,
  /writing.*score/i,
  /writing.*\/\s*50/i,
  /writing.*total/i,
  /w\.\s*score/i,
  /\/50/,
  /score.*writing/i
];

function matchesNameColumn(header) {
  const h = String(header || '').trim();
  return NAME_PATTERNS.some(pattern => pattern.test(h));
}

function matchesWritingColumn(header) {
  const h = String(header || '').trim();
  return WRITING_PATTERNS.some(pattern => pattern.test(h));
}

function isValidStudentName(name) {
  if (!name || name.length < 2) return false;
  const lower = name.toLowerCase();
  // Skip day names, common header words, numbers-only
  const skipPatterns = [
    /^(sat|sun|mon|tue|wed|thu|fri)\s/i,
    /^(saturday|sunday|monday|tuesday|wednesday|thursday|friday)/i,
    /^\d+$/,
    /^total$/i,
    /^average$/i,
    /^mean$/i,
    /^class$/i
  ];
  return !skipPatterns.some(p => p.test(lower));
}

function importExcel(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      
      // Get the first sheet
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      
      // Convert to JSON with headers
      const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      
      if (jsonData.length < 2) {
        alert('Excel file must have at least a header row and one data row.');
        return;
      }
      
      // Find header row and column indices using fuzzy matching
      let headerIndex = -1;
      let nameColIndex = -1;
      let scoreColIndex = -1;
      
      // Scan first 10 rows for headers
      for (let i = 0; i < Math.min(10, jsonData.length); i++) {
        const row = jsonData[i];
        if (!row) continue;
        
        for (let j = 0; j < row.length; j++) {
          const header = String(row[j] || '').trim();
          
          // Check for name column
          if (nameColIndex < 0 && matchesNameColumn(header)) {
            nameColIndex = j;
            headerIndex = i;
          }
          
          // Check for writing score column
          if (scoreColIndex < 0 && matchesWritingColumn(header)) {
            scoreColIndex = j;
            if (headerIndex < 0) headerIndex = i;
          }
        }
        
        // Stop if we found both columns
        if (nameColIndex >= 0 && scoreColIndex >= 0) break;
      }
      
      if (nameColIndex < 0) {
        alert('Could not find a Name column. Expected headers like: "Student Name", "Name", "Candidate", "First Name"');
        return;
      }
      
      if (scoreColIndex < 0) {
        alert('Could not find a Writing Score column. Expected headers like: "Writing Score", "Writing", "Writing /50", "W. Score"');
        return;
      }
      
      // Parse student rows
      const students = [];
      for (let i = headerIndex + 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (!row) continue;
        
        const name = row[nameColIndex] ? String(row[nameColIndex]).trim() : '';
        const scoreRaw = row[scoreColIndex];
        
        // Skip invalid names
        if (!isValidStudentName(name)) continue;
        
        // Extract numeric score
        let score = 0;
        if (typeof scoreRaw === 'number') {
          score = Math.round(scoreRaw);
        } else if (typeof scoreRaw === 'string') {
          const scoreMatch = scoreRaw.match(/(\d+)/);
          if (scoreMatch) score = parseInt(scoreMatch[1], 10);
        }
        
        students.push({ name, score });
      }
      
      populateTable(students, 'Excel');
    } catch (err) {
      alert('Error reading Excel file: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

function importCSV(file) {
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const lines = text.split('\n').map(line => line.trim()).filter(line => line);
    
    if (lines.length < 2) {
      alert('CSV file must have at least a header row and one data row.');
      return;
    }
    
    // Find header row using fuzzy matching (scan first 10 rows)
    let headerIndex = -1;
    let nameColIndex = -1;
    let scoreColIndex = -1;
    
    for (let i = 0; i < Math.min(10, lines.length); i++) {
      const cells = parseCSVLine(lines[i]);
      for (let j = 0; j < cells.length; j++) {
        const header = cells[j].trim();
        
        // Check for name column
        if (nameColIndex < 0 && matchesNameColumn(header)) {
          nameColIndex = j;
          headerIndex = i;
        }
        
        // Check for writing score column
        if (scoreColIndex < 0 && matchesWritingColumn(header)) {
          scoreColIndex = j;
          if (headerIndex < 0) headerIndex = i;
        }
      }
      
      // Stop if we found both columns
      if (nameColIndex >= 0 && scoreColIndex >= 0) break;
    }
    
    if (nameColIndex < 0) {
      alert('Could not find a Name column. Expected headers like: "Student Name", "Name", "Candidate", "First Name"');
      return;
    }
    
    if (scoreColIndex < 0) {
      alert('Could not find a Writing Score column. Expected headers like: "Writing Score", "Writing", "Writing /50", "W. Score"');
      return;
    }
    
    // Parse student rows
    const students = [];
    for (let i = headerIndex + 1; i < lines.length; i++) {
      const cells = parseCSVLine(lines[i]);
      const name = cells[nameColIndex] ? cells[nameColIndex].trim() : '';
      const scoreText = cells[scoreColIndex] ? cells[scoreColIndex].trim() : '';
      
      // Skip invalid names
      if (!isValidStudentName(name)) continue;
      
      // Extract numeric score (handle formats like "45/50" or "45" or empty/0)
      let score = 0;
      const scoreMatch = scoreText.match(/(\d+)/);
      if (scoreMatch) {
        score = parseInt(scoreMatch[1], 10);
      }
      
      students.push({ name, score });
    }
    
    populateTable(students, 'CSV');
  };
  
  reader.readAsText(file);
}

function populateTable(students, sourceType) {
  if (students.length === 0) {
    alert(`No valid student data found in ${sourceType} file.`);
    return;
  }
  
  const prefix = document.getElementById('prefix').value;
  const suffix = document.getElementById('suffix').value;
  const ext = getSelectedExtension();
  const tableSection = document.getElementById('table-section');
  const tbody = document.querySelector('#students-table tbody');
  tbody.innerHTML = '';
  
  students.forEach(student => {
    const row = document.createElement('tr');
    
    // Name
    const tdName = document.createElement('td');
    tdName.innerHTML = `<input type="text" class="input" value="${student.name}">`;
    row.appendChild(tdName);
    
    // Writing Score (convert from /50 to /20 if needed)
    const tdScore = document.createElement('td');
    const normalizedScore = student.score > 20 ? Math.round(student.score * 20 / 50) : student.score;
    tdScore.innerHTML = `<input type="number" class="input" value="${normalizedScore}" min="0" max="20">`;
    row.appendChild(tdScore);
    
    // Reading File
    const tdReading = document.createElement('td');
    const readingFile = `${prefix}${sanitizeFilename(student.name)}_reading.${ext}${suffix}`.replace(/_+/g, '_');
    tdReading.innerHTML = `<input type="text" class="input" value="${readingFile}">`;
    row.appendChild(tdReading);
    
    // QRAR File
    const tdQRAR = document.createElement('td');
    const qrarFile = `${prefix}${sanitizeFilename(student.name)}_qrar.${ext}${suffix}`.replace(/_+/g, '_');
    tdQRAR.innerHTML = `<input type="text" class="input" value="${qrarFile}">`;
    row.appendChild(tdQRAR);
    
    // Remove
    const tdRemove = document.createElement('td');
    tdRemove.innerHTML = `<button type="button" class="button is-danger" onclick="this.closest('tr').remove()">Remove</button>`;
    row.appendChild(tdRemove);
    
    tbody.appendChild(row);
  });
  
  tableSection.style.display = '';
  alert(`Imported ${students.length} students from ${sourceType}.`);
}

function parseCSVLine(line) {
  const cells = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      cells.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  cells.push(current);
  
  return cells.map(cell => cell.replace(/^"|"$/g, '').trim());
}

function generateTable() {
  const names = document.getElementById('student-names').value.split('\n').map(n => n.trim()).filter(n => n);
  const prefix = document.getElementById('prefix').value;
  const suffix = document.getElementById('suffix').value;
  const ext = getSelectedExtension();
  const tableSection = document.getElementById('table-section');
  const tbody = document.querySelector('#students-table tbody');
  tbody.innerHTML = '';
  names.forEach(name => {
    const row = document.createElement('tr');
    // Name
    const tdName = document.createElement('td');
    tdName.innerHTML = `<input type="text" class="input" value="${name}">`;
    row.appendChild(tdName);
    // Writing Score
    const tdScore = document.createElement('td');
    tdScore.innerHTML = `<input type="number" class="input" value="0" min="0" max="20">`;
    row.appendChild(tdScore);
    // Reading File
    const tdReading = document.createElement('td');
    const readingFile = `${prefix}${sanitizeFilename(name)}_reading.${ext}${suffix}`.replace(/_+/g, '_');
    tdReading.innerHTML = `<input type="text" class="input" value="${readingFile}">`;
    row.appendChild(tdReading);
    // QRAR File
    const tdQRAR = document.createElement('td');
    const qrarFile = `${prefix}${sanitizeFilename(name)}_qrar.${ext}${suffix}`.replace(/_+/g, '_');
    tdQRAR.innerHTML = `<input type="text" class="input" value="${qrarFile}">`;
    row.appendChild(tdQRAR);
    // Remove
    const tdRemove = document.createElement('td');
    tdRemove.innerHTML = `<button type="button" class="button is-danger" onclick="this.closest('tr').remove()">Remove</button>`;
    row.appendChild(tdRemove);
    tbody.appendChild(row);
  });
  tableSection.style.display = names.length ? '' : 'none';
}

function downloadManifest() {
  const rows = document.querySelectorAll('#students-table tbody tr');
  const students = [];
  rows.forEach(row => {
    const cells = row.querySelectorAll('input');
    const name = cells[0].value.trim();
    const writing_score = parseInt(cells[1].value, 10) || 0;
    const reading_file = cells[2].value.trim();
    const qrar_file = cells[3].value.trim();
    if (name && reading_file && qrar_file) {
      students.push({ name, writing_score, reading_file, qrar_file });
    }
  });
  const manifest = { students };
  const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'manifest.json';
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 100);
}
</script>
{% endblock %}
