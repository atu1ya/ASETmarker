{% extends "base.html" %}
{% block title %}Batch Processing &middot; ASET Marking System{% endblock %}

{% block content %}
<div id="flash-container"></div>
<a href="/" class="btn btn-outline btn-sm mb-2">&larr; Back to Dashboard</a>
<h1>Batch Processing</h1>
<p class="text-muted">Process an entire class in one run using a manifest and ZIP of scans.</p>

<section class="card mb-3">
    <header class="card-header">
        <h2 class="card-title">Configuration Summary</h2>
        <p class="card-subtitle">The following configuration will be applied to all students.</p>
    </header>
    <ul>
        <li><strong>Reading questions:</strong> {{ config_summary.reading_questions }}</li>
        <li><strong>QR questions:</strong> {{ config_summary.qr_questions }}</li>
        <li><strong>AR questions:</strong> {{ config_summary.ar_questions }}</li>
        <li><strong>Mapped subjects:</strong> {{ config_summary.subjects | join(', ') }}</li>
        {% if not config_summary.has_concept_mapping %}
        <li><strong>⚠️ Note:</strong> <span class="text-muted">No concept mapping uploaded - reports will not be generated</span></li>
        {% endif %}
    </ul>
</section>

<section class="card" id="batch-form-container">
    <header class="card-header">
        <h2 class="card-title">Upload Manifest and Sheets</h2>
        <p class="card-subtitle">Manifest file should list students with matching PNG filenames in the ZIP.</p>
    </header>
    <p>Manifest format:</p>
<pre>{
  "students": [
    {
      "name": "John Smith",
      "writing_score": 85,
      "reading_file": "john_reading.png",
      "qrar_file": "john_qrar.png"
    }
  ]
}
</pre>
    <p class="form-text">Download a <a href="/docs/sample_manifest.json" download>sample manifest</a> to get started.</p>
    <form id="batch-form" method="post" action="/batch/process" enctype="multipart/form-data">
        <div class="form-group">
            <label class="form-label" for="manifest">Manifest (JSON)</label>
            <div class="file-input-wrapper">
                <span class="file-icon">&#128462;</span>
                <span class="file-text">Click to upload or drop file here</span>
                <input type="file" id="manifest" name="manifest" accept=".json" required>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Upload Method</label>
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button type="button" class="btn btn-outline upload-method-btn active" data-method="zip" onclick="switchUploadMethod('zip')">ZIP File</button>
                <button type="button" class="btn btn-outline upload-method-btn" data-method="folder" onclick="switchUploadMethod('folder')">Folder</button>
                <button type="button" class="btn btn-outline upload-method-btn" data-method="files" onclick="switchUploadMethod('files')">Individual Files</button>
            </div>
        </div>
        
        <!-- ZIP Upload -->
        <div class="form-group upload-section" id="upload-zip">
            <label class="form-label" for="sheets_zip">Sheets Archive (ZIP)</label>
            <div class="file-input-wrapper">
                <span class="file-icon">&#128230;</span>
                <span class="file-text">Click to upload or drop ZIP file here</span>
                <input type="file" id="sheets_zip" name="sheets_zip" accept=".zip">
            </div>
            <p class="form-text">Upload a ZIP file containing all student scan images.</p>
        </div>
        
        <!-- Folder Upload -->
        <div class="form-group upload-section" id="upload-folder" style="display: none;">
            <label class="form-label" for="sheets_folder">Select Folder</label>
            <div class="file-input-wrapper">
                <span class="file-icon">&#128194;</span>
                <span class="file-text">Click to select a folder containing images</span>
                <input type="file" id="sheets_folder" name="sheets_zip" accept=".png,.jpg,.jpeg" webkitdirectory multiple>
            </div>
            <p class="form-text">Select a folder containing PNG, JPG, or JPEG images.</p>
        </div>
        
        <!-- Individual Files Upload -->
        <div class="form-group upload-section" id="upload-files" style="display: none;">
            <label class="form-label" for="sheets_files">Select Images</label>
            <div class="file-input-wrapper">
                <span class="file-icon">&#128444;</span>
                <span class="file-text">Click to select multiple image files</span>
                <input type="file" id="sheets_files" name="sheets_zip" accept=".png,.jpg,.jpeg" multiple>
            </div>
            <p class="form-text">Select multiple PNG, JPG, or JPEG image files.</p>
        </div>
        
        <button type="submit" class="btn btn-primary">Process Batch</button>
    </form>
</section>

<script>
function switchUploadMethod(method) {
    // Update button states
    document.querySelectorAll('.upload-method-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.method === method) {
            btn.classList.add('active');
        }
    });
    
    // Show/hide upload sections and clear inputs
    document.querySelectorAll('.upload-section').forEach(section => {
        section.style.display = 'none';
        const input = section.querySelector('input[type="file"]');
        if (input) {
            input.value = '';
            input.disabled = true;
            // Clear file name display
            const nameEl = section.querySelector('.file-name');
            if (nameEl) nameEl.remove();
        }
    });
    
    // Show selected section and enable its input
    const activeSection = document.getElementById('upload-' + method);
    if (activeSection) {
        activeSection.style.display = 'block';
        const input = activeSection.querySelector('input[type="file"]');
        if (input) {
            input.disabled = false;
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set initial state - ZIP is active by default
    switchUploadMethod('zip');
});
</script>

<section id="results-section" class="card results-section hidden">
    <div class="results-icon">&#10003;</div>
    <h2>Batch Download in progress</h2>
    <p class="text-muted">Your ZIP download should begin shortly. If it does not, please retry.</p>
    <button class="btn btn-outline" type="button" onclick="resetAndShowForm('batch-form-container', 'results-section')">Run Another Batch</button>
</section>
{% endblock %}
